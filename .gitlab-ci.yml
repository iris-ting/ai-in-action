stages:
  - diff
  - testgen

print_python_diff:
  stage: diff
  image: python:3.10
  script:
    - echo "Getting modified Python files..."
    - python3 get_diff.py
  only:
    - merge_requests
    - branches
  

generate_tests:
  stage: testgen
  image: python:3.10
  cache:
    key: pip-cache
    paths:
      - ~/.cache/pip
  script:
    - pip install -r requirements.txt
    - echo "Generating test scripts..."
    - python3 get_test_script.py
  artifacts:
    paths:
      - generated_tests/
    expire_in: 1 hour
  only:
    - merge_requests
    - branches
  dependencies:
    - print_python_diff

  

run_generated_tests:
  stage: testgen
  image: python:3.10
  cache:
    key: pip-cache
    paths:
      - ~/.cache/pip
  script:
    - pip install pytest
    - echo "ğŸ§ª Checking generated test files..."
    - ls -lh generated_tests/ || echo "generated_tests/ folder not found"
    - |
      if [ -d generated_tests ] && [ "$(ls -A generated_tests)" ]; then
        echo "âœ… Running tests in generated_tests/"
        pytest generated_tests/ || echo "âš ï¸ No valid tests found, but continuing."
      else
        echo "âš ï¸ No test files found in generated_tests/, skipping test step."
      fi
  dependencies:
    - generate_tests
  only:
    - merge_requests
    - branches


commit_tests:
  stage: testgen
  image: python:3.10
  script:
    - git config --global user.name "cc19judy"
    - git config --global user.email "judy971119@gmail.com"
    - git checkout $CI_COMMIT_REF_NAME
    - git add generated_tests/
    - git commit -m "ğŸ¤– Add auto-generated test scripts" || echo "Nothing to commit"
    - git push https://gitlab-ci-token:${CI_PUSH_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git HEAD:$CI_COMMIT_REF_NAME
  only:
    - merge_requests
    - branches
  dependencies:
    - generate_tests
