stages:
  - testgen
  - push-back

variables:
  GIT_USER_NAME: "judy"
  GIT_USER_EMAIL: "judy971119@gmail.com"
  TARGET_BRANCH: "main"
  TARGET_REPO: "https://oauth2:${CI_PUSH_TOKEN}@gitlab.com/iris-ting/ai-in-action.git"
  TARGET_REPO_NAME: "ai-in-action"

generate_tests:
  stage: testgen
  image: python:3.10
  cache:
    key: pip-cache
    paths:
      - ~/.cache/pip
  script:
    - pip install -r requirements.txt
    - echo "Generating test scripts..."
    - python3 get_test_script.py
  artifacts:
    paths:
      - generated_tests/
    expire_in: 1 hour
  only:
    - merge_requests
    - branches


push-artifact:
  stage: push-back
  script:
    - git config --global user.name "$GIT_USER_NAME"
    - git config --global user.email "$GIT_USER_EMAIL"
    - git clone "$TARGET_REPO"
    - cd "$TARGET_REPO_NAME"
    - git checkout "$TARGET_BRANCH"
    - cp -r ../generated_tests .
    - git add generated_tests
    - git commit -m "ðŸ¤– Add auto-generated test scripts" || echo "Nothing to commit"
    - git push "$TARGET_REPO" HEAD:"$TARGET_BRANCH"
  dependencies:
    - generate_tests